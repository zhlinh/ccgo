# CCGO generated file: DO NOT EDIT!
# Generated by "CCGO" Template Generator of CMake, CCGO Template Version 1.0.0
#
# Copyright 2024 zhlinh and ccgo Project Authors. All rights reserved.
# Use of this source code is governed by a MIT-style
# license that can be found at
#
# https://opensource.org/license/MIT
#
# The above copyright notice and this permission
# notice shall be included in all copies or
# substantial portions of the Software.

cmake_minimum_required(VERSION 3.14)

# Force installation to build directory instead of system directories
# This ensures all build artifacts stay within the project for easier distribution
set(CMAKE_INSTALL_PREFIX "${CMAKE_BINARY_DIR}" CACHE PATH "Installation directory" FORCE)
message(STATUS "CMAKE_INSTALL_PREFIX=${CMAKE_INSTALL_PREFIX}")

# Extract project name from the source directory path
# For example: /path/to/myproject -> myproject
set(MAIN_PROJECT_ROOT_DIR ${CMAKE_SOURCE_DIR})
string(REPLACE "/" ";" TEMP_SPLIT_ITEMS "${CMAKE_SOURCE_DIR}")  # Split path by '/'
list(GET TEMP_SPLIT_ITEMS -1 MAIN_PROJECT_NAME)  # Get last element as project name

# Define project with C++ and C language support
project(${MAIN_PROJECT_NAME} CXX C)

## Include project-specific CMake utilities and compiler flags
include(${CCGO_CMAKE_DIR}/CMakeUtils.cmake)        # Custom CMake helper functions
include(${CCGO_CMAKE_DIR}/CMakeExtraFlags.cmake)   # Platform-specific compiler flags

# Add project root to include paths for header file resolution
include_directories(./)

## Configure and build third-party dependencies (optional)
# Subdirectories are added in file system order to ensure consistent build behavior
if(THIRD_PARTY_OPTION)
    # Dynamically generate third_party/CMakeLists.txt from template
    # This allows runtime customization of third-party dependencies
    configure_file(
            ${CCGO_CMAKE_DIR}/template/ThirdParty.CMakeLists.txt.in
            ${CMAKE_SOURCE_DIR}/third_party/CMakeLists.txt
            NEWLINE_STYLE LF  # Use Unix-style line endings for cross-platform compatibility
            @ONLY             # Only replace @VAR@ syntax, not ${VAR}
    )
    # Add third_party as subdirectory with custom binary directory name
    add_subdirectory(third_party ${PROJECT_NAME}-third_party)
endif()

## Configure and build main source code
# Generate src/CMakeLists.txt from template
configure_file(
        ${CCGO_CMAKE_DIR}/template/Src.CMakeLists.txt.in
        ${CMAKE_SOURCE_DIR}/src/CMakeLists.txt
        NEWLINE_STYLE LF
        @ONLY
)
# Add source directory with custom binary directory name
add_subdirectory(src ${PROJECT_NAME}-src)

# Discover all subdirectories within src/ for modular compilation
# This allows automatic detection of feature modules (e.g., src/network, src/storage)
set(SRC_SUB_DIR_LIST "")
get_subdirectories(SRC_SUB_DIR_LIST "${CMAKE_CURRENT_SOURCE_DIR}/src")
message(STATUS "SRC_SUB_DIR_LIST=${SRC_SUB_DIR_LIST}")

## Configure GoogleTest framework for unit testing (optional)
if(GOOGLETEST_SUPPORT)
    # Download and build GoogleTest v1.16.x from GitHub
    add_cc_external(
        NAME                      googletest
        DOWNLOAD_URL              "https://github.com/google/googletest/archive/v1.16.x.zip"
        SOURCE_DIR                "${CMAKE_BINARY_DIR}/googletest-src"
        BUILD_DIR                 "${CMAKE_BINARY_DIR}/googletest-build"
        INCLUDES                  "googletest/include googlemock/include"  # Both gtest and gmock headers
        EXTRA_CONFIGURE_COMMANDS  "-Dgtest_force_shared_crt=ON"  # Use shared CRT on Windows (MSVC)
        EXTRA_BUILD_COMMANDS      ""
        SHARED                    # Build as shared library
    )
    # Generate tests/CMakeLists.txt from template
    configure_file(
            ${CCGO_CMAKE_DIR}/template/Tests.CMakeLists.txt.in
            ${CMAKE_SOURCE_DIR}/tests/CMakeLists.txt
            NEWLINE_STYLE LF
            @ONLY
    )
    # Add tests subdirectory for unit test compilation
    add_subdirectory("tests" "${PROJECT_NAME}-tests")
endif()

## Configure Google Benchmark framework for performance testing (optional)
if(BENCHMARK_SUPPORT)
    # Download and build Google Benchmark v1.8.5 from GitHub
    add_cc_external(
        NAME                      googlebenchmark
        DOWNLOAD_URL              "https://github.com/google/benchmark/archive/v1.8.5.zip"
        SOURCE_DIR                "${CMAKE_BINARY_DIR}/googlebenchmark-src"
        BUILD_DIR                 "${CMAKE_BINARY_DIR}/googlebenchmark-build"
        EXTRA_CONFIGURE_COMMANDS  "-DBENCHMARK_ENABLE_GTEST_TESTS=OFF"  # Disable benchmark's internal tests
        EXTRA_BUILD_COMMANDS      ""
        SHARED                    # Build as shared library
    )
    # Generate benches/CMakeLists.txt from template
    configure_file(
            ${CCGO_CMAKE_DIR}/template/Benches.CMakeLists.txt.in
            ${CMAKE_SOURCE_DIR}/benches/CMakeLists.txt
            NEWLINE_STYLE LF
            @ONLY
    )
    # Add benches subdirectory for benchmark compilation
    add_subdirectory("benches" "${PROJECT_NAME}-benches")
endif()

# Output directory for final build artifacts (named after OS: Darwin.out, Linux.out, Windows.out)
set(SELF_LIBS_OUT ${CMAKE_SYSTEM_NAME}.out)

## Build Mode 1: GoogleTest Executable
# Creates a test executable when GOOGLETEST_SUPPORT is enabled
if(GOOGLETEST_SUPPORT)
    set(GOOGLETEST_NAME "${PROJECT_NAME}_googletest")
    set(CMAKE_PROJECT_NAME ${GOOGLETEST_NAME})

    # Collect all test source files (*.cc) from tests/ directory
    file(GLOB SELF_TEMP_SRC_FILES RELATIVE ${PROJECT_SOURCE_DIR} tests/*.cc)
    list(APPEND GOOGLETEST_SUPPORT_FILES ${SELF_TEMP_SRC_FILES})

    # Build link dependencies in order: tests first, then source modules
    list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-tests)
    foreach(DIR IN LISTS SRC_SUB_DIR_LIST)
        list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-${DIR})
    endforeach()

    # Collect third-party library binaries and linker flags
    set(TEMP_TARGET_SRC_LINKS "")
    set(TEMP_TARGET_LINK_FLAGS "")
    get_third_party_binary_files(TEMP_TARGET_SRC_LINKS TEMP_TARGET_LINK_FLAGS)
    list(APPEND TARGET_SRC_LINKS ${TEMP_TARGET_SRC_LINKS})

    if(THIRD_PARTY_OPTION)
        list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-third_party)
    endif()

    # Create test executable from collected test sources
    add_executable(${GOOGLETEST_NAME} ${GOOGLETEST_SUPPORT_FILES})

    # Apply third-party linker flags if present (e.g., -Wl,--exclude-libs for Android)
    if (NOT ${TEMP_TARGET_LINK_FLAGS} STREQUAL "")
      set_target_properties(${GOOGLETEST_NAME} PROPERTIES LINK_FLAGS ${TEMP_TARGET_LINK_FLAGS})
    endif()

    # Windows-specific: Disable DLL export/import for static library usage
    if (MSVC)
      target_compile_definitions(${GOOGLETEST_NAME} PRIVATE -DCOMM_ENABLE_EXPORTS=0)
    endif()

    # macOS/iOS-specific: Link required system frameworks
    if (APPLE)
      # Foundation, Cocoa: Core macOS/iOS APIs
      set(OTHER_FRAMEWORKS "-framework Foundation -framework Cocoa -framework IOKit -framework SystemConfiguration")
      # OpenCL, Accelerate: GPU computing and vector operations
      set(OTHER_FRAMEWORKS "${OTHER_FRAMEWORKS} -framework OpenCL -framework Accelerate")
      # Network, Security: Networking and SSL/TLS
      set(OTHER_FRAMEWORKS "${OTHER_FRAMEWORKS}  -framework Network -framework Security")
    endif()

    message(STATUS "GOOGLETEST-> TARGET_SRC_LINKS=${TARGET_SRC_LINKS}")

    # Link test executable with project modules, GoogleTest, and system libraries
    target_link_libraries(
            ${GOOGLETEST_NAME}
            ${TARGET_SRC_LINKS}     # Project modules (tests, src subdirs, third_party)
            gtest_main              # GoogleTest main() function
            ${ZLIB_LIBRARY}         # Compression library
            ${MINIZIP_LIBRARY}      # ZIP archive support
            ${OTHER_FRAMEWORKS}     # Platform-specific frameworks (macOS/iOS)
    )
    set_property(TARGET ${GOOGLETEST_NAME} PROPERTY LINKER_LANGUAGE "CXX")

    set_target_properties(${GOOGLETEST_NAME} PROPERTIES OUTPUT_NAME ${GOOGLETEST_NAME})

    # IDE-specific: Set default command-line arguments for debugging
    if (APPLE AND ${CMAKE_GENERATOR} STREQUAL "Xcode")
        set_target_properties(${GOOGLETEST_NAME} PROPERTIES XCODE_SCHEME_ARGUMENTS "--debuglog")
    elseif(MSVC)
        set_target_properties(${GOOGLETEST_NAME} PROPERTIES VS_DEBUGGER_COMMAND_ARGUMENTS "--debuglog")
        # Set as startup project in Visual Studio
        set_property(DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY VS_STARTUP_PROJECT ${GOOGLETEST_NAME})
    elseif(CMAKE_GENERATOR STREQUAL "CodeLite")
        set(CMAKE_CODELITE_USE_TARGETS ON)
    endif()

    # Install test executable to output directory
    install(TARGETS ${GOOGLETEST_NAME} RUNTIME DESTINATION ${SELF_LIBS_OUT})

elseif(BENCHMARK_SUPPORT)
    ## Build Mode 2: Google Benchmark Executable
    # Creates a benchmark executable when BENCHMARK_SUPPORT is enabled
    set(BENCHMARK_NAME "${PROJECT_NAME}_benchmark")
    set(CMAKE_PROJECT_NAME ${BENCHMARK_NAME})

    # Collect all benchmark source files (*.cc) from benches/ directory
    file(GLOB SELF_TEMP_SRC_FILES
        RELATIVE ${PROJECT_SOURCE_DIR}
        "benches/*.cc"
    )
    list(APPEND BENCHMARK_SUPPORT_FILES ${SELF_TEMP_SRC_FILES})

    # Build link dependencies in order: benches first, then source modules
    list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-benches)
    foreach(DIR IN LISTS SRC_SUB_DIR_LIST)
        list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-${DIR})
    endforeach()

    # Collect third-party library binaries and linker flags
    set(TEMP_TARGET_SRC_LINKS "")
    set(TEMP_TARGET_LINK_FLAGS "")
    get_third_party_binary_files(TEMP_TARGET_SRC_LINKS TEMP_TARGET_LINK_FLAGS)
    list(APPEND TARGET_SRC_LINKS ${TEMP_TARGET_SRC_LINKS})

    if(THIRD_PARTY_OPTION)
        list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-third_party)
    endif()

    # macOS/iOS-specific: Link required system frameworks
    if (APPLE)
      set(OTHER_FRAMEWORKS "-framework Foundation -framework Cocoa -framework IOKit -framework SystemConfiguration")
      set(OTHER_FRAMEWORKS "${OTHER_FRAMEWORKS} -framework OpenCL -framework Accelerate")
      set(OTHER_FRAMEWORKS "${OTHER_FRAMEWORKS} -framework Network -framework Security")
    endif()

    # Create benchmark executable
    add_executable(${BENCHMARK_NAME} ${file})
    target_link_libraries(
            ${BENCHMARK_NAME}
            ${TARGET_SRC_LINKS}
            benchmark_main          # Google Benchmark main() function
            ${ZLIB_LIBRARY}
            ${MINIZIP_LIBRARY}
            ${OTHER_FRAMEWORKS}
    )

    # Apply third-party linker flags if present
    if (NOT ${TEMP_TARGET_LINK_FLAGS} STREQUAL "")
      set_target_properties(${BENCHMARK_NAME} PROPERTIES LINK_FLAGS ${TEMP_TARGET_LINK_FLAGS})
    endif()

    # Windows-specific: Disable DLL export/import
    if (MSVC)
      target_compile_definitions(${BENCHMARK_NAME} PRIVATE -DCOMM_ENABLE_EXPORTS=0)
    endif()

    # Install benchmark executable to output directory
    install(TARGETS ${BENCHMARK_NAME} RUNTIME DESTINATION ${SELF_LIBS_OUT})

else()
    ## Build Mode 3: Platform-Specific Shared Library
    # Creates distributable shared libraries for Android, OHOS, etc.
    if(ANDROID)
        ### Android Shared Library (.so) Build
        # Configure linker search paths for third-party libraries
        list(APPEND LINK_SRC_DIRS third_party)
        link_directories(${LINK_SRC_DIRS})

        # Link all source module static libraries
        foreach(DIR IN LISTS SRC_SUB_DIR_LIST)
            list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-${DIR})
        endforeach()

        # Include Android-specific public API headers
        file(GLOB SELF_TEMP_SRC_FILES RELATIVE ${PROJECT_SOURCE_DIR} include/${PROJECT_NAME}/api/android/*.h)
        list(APPEND SELF_SRC_FILES ${SELF_TEMP_SRC_FILES})
        source_group(api FILES ${SELF_TEMP_SRC_FILES})

        # Include Android-specific implementation headers
        file(GLOB SELF_TEMP_SRC_FILES RELATIVE ${PROJECT_SOURCE_DIR} src/api/android/*.h)
        list(APPEND SELF_SRC_FILES ${SELF_TEMP_SRC_FILES})

        # Remove any test files from production build
        exclude_unittest_files(SELF_SRC_FILES)

        # Collect third-party binaries and special linker flags
        set(TEMP_TARGET_SRC_LINKS "")
        set(TEMP_TARGET_LINK_FLAGS "")
        get_third_party_binary_files(TEMP_TARGET_SRC_LINKS TEMP_TARGET_LINK_FLAGS)
        list(APPEND TARGET_SRC_LINKS ${TEMP_TARGET_SRC_LINKS})

        if(THIRD_PARTY_OPTION)
            message(STATUS "FOUND ${PROJECT_NAME}-third_party")
            list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-third_party)
        endif()

        # Configure library search patterns for Android
        set(CMAKE_FIND_LIBRARY_PREFIXES "lib")
        set(CMAKE_FIND_LIBRARY_SUFFIXES ".so" ".a")

        # Link Android system libraries
        list(APPEND TARGET_SRC_LINKS log)  # Android logging (__android_log_print)
        list(APPEND TARGET_SRC_LINKS z)    # zlib compression (avoid find_library for fortify issues)

        # Create shared library from all collected sources
        add_library(${PROJECT_NAME} SHARED ${SELF_SRC_FILES})

        # Install library to output directory
        install(TARGETS ${PROJECT_NAME} LIBRARY DESTINATION ${SELF_LIBS_OUT} ARCHIVE DESTINATION ${SELF_LIBS_OUT})

        message(STATUS "TARGET_SRC_LINKS=${TARGET_SRC_LINKS}")

        # Set SO-NAME for proper runtime linking (critical for Android)
        # Format: lib{project}.so (without version suffix)
        set_target_properties(${PROJECT_NAME} PROPERTIES LINK_FLAGS "-Wl,-h,lib${PROJECT_NAME}.so")

        # Link all dependencies (source modules, third-party, system libs)
        target_link_libraries(${PROJECT_NAME} PUBLIC ${TARGET_SRC_LINKS})
        set_property(TARGET ${PROJECT_NAME} PROPERTY LINKER_LANGUAGE "CXX")
    elseif(OHOS)
        ### OpenHarmony (OHOS) Shared Library (.so) Build
        # Configure linker search paths for third-party libraries
        list(APPEND LINK_SRC_DIRS third_party)
        link_directories(${LINK_SRC_DIRS})

        # Link all source module static libraries
        foreach(DIR IN LISTS SRC_SUB_DIR_LIST)
            list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-${DIR})
        endforeach()

        # Include OHOS-specific public API headers
        file(GLOB SELF_TEMP_SRC_FILES RELATIVE ${PROJECT_SOURCE_DIR} include/${PROJECT_NAME}/api/ohos/*.h)
        list(APPEND SELF_SRC_FILES ${SELF_TEMP_SRC_FILES})
        source_group(api FILES ${SELF_TEMP_SRC_FILES})

        # Include OHOS-specific implementation headers
        file(GLOB SELF_TEMP_SRC_FILES RELATIVE ${PROJECT_SOURCE_DIR} src/api/ohos/*.h)
        list(APPEND SELF_SRC_FILES ${SELF_TEMP_SRC_FILES})

        # Remove any test files from production build
        exclude_unittest_files(SELF_SRC_FILES)

        # Collect third-party binaries and special linker flags
        set(TEMP_TARGET_SRC_LINKS "")
        set(TEMP_TARGET_LINK_FLAGS "")
        get_third_party_binary_files(TEMP_TARGET_SRC_LINKS TEMP_TARGET_LINK_FLAGS)
        list(APPEND TARGET_SRC_LINKS ${TEMP_TARGET_SRC_LINKS})

        if(THIRD_PARTY_OPTION)
            message(STATUS "FOUND ${PROJECT_NAME}-third_party")
            list(APPEND TARGET_SRC_LINKS ${PROJECT_NAME}-third_party)
        endif()

        # Configure library search patterns for OHOS
        set(CMAKE_FIND_LIBRARY_PREFIXES "lib")
        set(CMAKE_FIND_LIBRARY_SUFFIXES ".so" ".a")

        # Link OHOS system libraries (HarmonyOS-specific)
        list(APPEND TARGET_SRC_LINKS libace_napi.z.so)        # NAPI bindings for Node-API compatibility
        list(APPEND TARGET_SRC_LINKS libhilog_ndk.z.so)       # HiLog logging framework
        list(APPEND TARGET_SRC_LINKS libnet_connection.so)    # Network connectivity APIs
        list(APPEND TARGET_SRC_LINKS libz.so)                 # zlib compression

        # Create shared library from all collected sources
        add_library(${PROJECT_NAME} SHARED ${SELF_SRC_FILES})

        # Install library to output directory
        install(TARGETS ${PROJECT_NAME} LIBRARY DESTINATION ${SELF_LIBS_OUT} ARCHIVE DESTINATION ${SELF_LIBS_OUT})

        message(STATUS "TARGET_SRC_LINKS=${TARGET_SRC_LINKS}")

        # Set SO-NAME for proper runtime linking (critical for OHOS)
        # Format: lib{project}.so (without version suffix)
        set_target_properties(${PROJECT_NAME} PROPERTIES LINK_FLAGS "-Wl,-h,lib${PROJECT_NAME}.so")

        # Link all dependencies (source modules, third-party, system libs)
        target_link_libraries(${PROJECT_NAME} PUBLIC ${TARGET_SRC_LINKS})
        set_property(TARGET ${PROJECT_NAME} PROPERTY LINKER_LANGUAGE "CXX")

    elseif(APPLE)
        # Apple platforms (iOS/macOS): Static libraries are built and installed
        # via src/CMakeLists.txt and assembled into frameworks by build scripts
    elseif(MSVC)
        # Windows (MSVC): Static libraries are built and installed
        # via src/CMakeLists.txt and merged by build scripts
    endif()
endif()
