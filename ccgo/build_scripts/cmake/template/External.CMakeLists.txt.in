# CCGO generated file: DO NOT EDIT!
# Generated by "CCGO" Template Generator of CMake, CCGO Template Version 1.0.0
#
# Copyright 2024 zhlinh and ccgo Project Authors. All rights reserved.
# Use of this source code is governed by a MIT-style
# license that can be found at
#
# https://opensource.org/license/MIT
#
# The above copyright notice and this permission
# notice shall be included in all copies or
# substantial portions of the Software.

## External Dependency Download and Build System
# This template sets up external projects (e.g., GoogleTest, Benchmark)
# by downloading from GitHub and building them as part of the project.
#
# Template variables (replaced by add_cc_external):
# - @COMM_EXTERNAL_NAME@: Library name (e.g., "googletest", "googlebenchmark")
# - @COMM_EXTERNAL_DOWNLOAD_URL@: Download URL (ZIP archive)
# - @COMM_EXTERNAL_SOURCE_DIR@: Where to extract sources
# - @COMM_EXTERNAL_BUILD_DIR@: Where to build
# - @COMM_EXTERNAL_INCLUDES@: Additional include directories
# - @COMM_EXTERNAL_EXTRA_CONFIGURE_COMMANDS@: Extra CMake options

# Generate download script from template
# This creates a minimal CMakeLists.txt that downloads and extracts the external library
configure_file(
        ${CCGO_CMAKE_DIR}/template/External.Download.txt.in
        ${CMAKE_BINARY_DIR}/@COMM_EXTERNAL_NAME@-external/CMakeLists.txt
        NEWLINE_STYLE LF
)
message(STATUS "Configuring @COMM_EXTERNAL_NAME@ from ${CMAKE_BINARY_DIR}/@COMM_EXTERNAL_NAME@-external")

# Save current compiler and output settings to restore later
# External dependencies may have different build requirements
set(COMM_SAVE_CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS})
set(COMM_SAVE_CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_RUNTIME_OUTPUT_DIRECTORY})

# Configure for shared library build if requested
if (BUILD_SHARED_LIBS)
    set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
    # GoogleTest-specific: Enable shared library creation
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DGTEST_CREATE_SHARED_LIBRARY=1")
endif()

## Download the external dependency
# Step 1: Run CMake on the download script to fetch the library
execute_process(COMMAND ${CMAKE_COMMAND} -G "${CMAKE_GENERATOR}" .
        RESULT_VARIABLE result
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}/@COMM_EXTERNAL_NAME@-external)
if(result)
    message(FATAL_ERROR "cmake [GEN] @COMM_EXTERNAL_NAME@ failed: ${result}")
endif()

# Step 2: Execute the download (runs at configure time, not build time)
# This downloads and extracts the library to @COMM_EXTERNAL_SOURCE_DIR@
execute_process(COMMAND ${CMAKE_COMMAND} --build .
        RESULT_VARIABLE result
        WORKING_DIRECTORY ${CMAKE_BINARY_DIR}/@COMM_EXTERNAL_NAME@-external)
if(result)
    message(FATAL_ERROR "cmake [BUILD] @COMM_EXTERNAL_NAME@ failed: ${result}")
endif()

## Parse and apply extra configuration commands
# Process CMake options like "-Dgtest_force_shared_crt=ON"
# These options customize the external library's build settings
set(OUTPUT "")
set(EXTRA_CONFIGURE_COMMANDS "@COMM_EXTERNAL_EXTRA_CONFIGURE_COMMANDS@")
if (EXTRA_CONFIGURE_COMMANDS)
  # Split space-separated commands into list
  string(REPLACE " " ";" COMMANDS_LIST "${EXTRA_CONFIGURE_COMMANDS}")
  message(STATUS "ExternalCFG COMMANDS_LIST ${COMMANDS_LIST}")

  # Process each command
  foreach(COMMAND IN LISTS COMMANDS_LIST)
      if("${COMMAND}" STREQUAL "")
          continue()
      endif()
      message(STATUS "ExternalCFG Configure command: ${COMMAND}")

      # Parse commands in format: -DVAR_NAME=VALUE (only ON/OFF supported)
      if("${COMMAND}" MATCHES "^-D([^=]+)=(ON|OFF)$")
          set(VAR_NAME ${CMAKE_MATCH_1})
          set(VALUE ${CMAKE_MATCH_2})

          string(APPEND OUTPUT
              "set(${VAR_NAME} ${VALUE})\n"
          )
          # Set as cache variable to affect external library's CMakeLists.txt
          set(${VAR_NAME} ${VALUE} CACHE BOOL "" FORCE)
          message(STATUS "ExternalCFG Success Setting ${VAR_NAME} to ${VALUE}")
      else()
          message(WARNING "ExternalCFG Skip Setting: ${COMMAND}")
      endif()
  endforeach()
else()
    message(STATUS "ExternalCFG No extra configure commands provided.")
endif()

message(STATUS "ExternalCFG Parsed configure commands:\n${OUTPUT}")

# Restore original compiler and output settings
set(CMAKE_CXX_FLAGS ${COMM_SAVE_CMAKE_CXX_FLAGS})
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${COMM_SAVE_CMAKE_RUNTIME_OUTPUT_DIRECTORY})

## Configure include directories for the external library
# Add default include directory (common location for headers)
include_directories(${COMM_EXTERNAL_SOURCE_DIR}/include)

# Add extra include directories if specified
# Example: "googletest/include googlemock/include"
set(TEMP_INCLUDES "@COMM_EXTERNAL_INCLUDES@")
if (TEMP_INCLUDES)
  # Split space-separated includes into list
  string(REPLACE " " ";" TEMP_INCLUDES_LIST "${TEMP_INCLUDES}")
  message(STATUS "ExternalINC INCLUDES_LIST ${TEMP_INCLUDES_LIST}")

  # Add each include directory
   foreach(TEMP_ITEM IN LISTS TEMP_INCLUDES_LIST)
       if("${TEMP_ITEM}" STREQUAL "")
           continue()
       endif()
       include_directories(${COMM_EXTERNAL_SOURCE_DIR}/${TEMP_ITEM})
       message(STATUS "ExternalINC include: ${COMM_EXTERNAL_SOURCE_DIR}/${TEMP_ITEM}")
   endforeach()
else()
  message(STATUS "ExternalINC No extra include directories provided.")
endif()

## Add external library to the build
# EXCLUDE_FROM_ALL prevents external library targets from appearing in "make all"
# The library will only be built when explicitly needed by other targets
add_subdirectory(${COMM_EXTERNAL_SOURCE_DIR} ${COMM_EXTERNAL_BUILD_DIR} EXCLUDE_FROM_ALL)
